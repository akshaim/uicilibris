<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>UiciLibris: uicilibris/expand.py Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">UiciLibris
   &#160;<span id="projectnumber">1.7</span>
   </div>
   
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('expand_8py.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">expand.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="expand_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceuicilibris_1_1expand.html">00001</a> <span class="comment">#!/usr/bin/env python</span>
<a name="l00002"></a>00002 <span class="comment">#       $Id: expand.py 19 2011-08-09 16:09:53Z georgesk $       </span>
<a name="l00003"></a>00003 <span class="comment">#</span>
<a name="l00004"></a>00004 <span class="comment"># expand.py is part of the package uicilibris</span>
<a name="l00005"></a>00005 <span class="comment">#</span>
<a name="l00006"></a>00006 <span class="comment"># uicilibris is based on wiki2beamer&#39;s code, which was authored by</span>
<a name="l00007"></a>00007 <span class="comment"># Michael Rentzsch and Kai Dietrich</span>
<a name="l00008"></a>00008 <span class="comment">#</span>
<a name="l00009"></a>00009 <span class="comment"># (c) 2007-2008 Michael Rentzsch (http://www.repc.de)</span>
<a name="l00010"></a>00010 <span class="comment"># (c) 2009-2010 Michael Rentzsch (http://www.repc.de)</span>
<a name="l00011"></a>00011 <span class="comment">#               Kai Dietrich (mail@cleeus.de)</span>
<a name="l00012"></a>00012 <span class="comment"># (c) 2011      Georges Khaznadar (georgesk@ofset.org)</span>
<a name="l00013"></a>00013 <span class="comment">#</span>
<a name="l00014"></a>00014 <span class="comment"># Create high-level parseable code from a wiki-like code, like LaTeX</span>
<a name="l00015"></a>00015 <span class="comment">#</span>
<a name="l00016"></a>00016 <span class="comment">#</span>
<a name="l00017"></a>00017 <span class="comment">#     This file is part of uicilibris.</span>
<a name="l00018"></a>00018 <span class="comment"># uicilibris is free software: you can redistribute it and/or modify</span>
<a name="l00019"></a>00019 <span class="comment"># it under the terms of the GNU General Public License as published by</span>
<a name="l00020"></a>00020 <span class="comment"># the Free Software Foundation, either version 2 of the License, or</span>
<a name="l00021"></a>00021 <span class="comment"># (at your option) any later version.</span>
<a name="l00022"></a>00022 <span class="comment">#</span>
<a name="l00023"></a>00023 <span class="comment"># uicilibris is distributed in the hope that it will be useful,</span>
<a name="l00024"></a>00024 <span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00025"></a>00025 <span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00026"></a>00026 <span class="comment"># GNU General Public License for more details.</span>
<a name="l00027"></a>00027 <span class="comment">#</span>
<a name="l00028"></a>00028 <span class="comment"># You should have received a copy of the GNU General Public License</span>
<a name="l00029"></a>00029 <span class="comment"># along with uicilibris.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">import</span> random, re, string, hashlib, sys
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">00033</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">syntax_error</a>(message, code):
<a name="l00034"></a>00034     <span class="keywordflow">print</span> &gt;&gt;sys.stderr, <span class="stringliteral">&#39;syntax error in [expand]: %s&#39;</span> % message
<a name="l00035"></a>00035     <span class="keywordflow">print</span> &gt;&gt;sys.stderr, <span class="stringliteral">&#39;\tcode:\n%s&#39;</span> % code
<a name="l00036"></a>00036     sys.exit(-3)
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="namespaceuicilibris_1_1expand.html#aa7c5fb372f99423998ded9e3bc442bbe">00038</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#aa7c5fb372f99423998ded9e3bc442bbe">md5hex</a>(string):
<a name="l00039"></a>00039     <span class="keywordflow">return</span> hashlib.md5(string).hexdigest()
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="namespaceuicilibris_1_1expand.html#acd820eb2d190c4c0d186bb41d070e10e">00041</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#acd820eb2d190c4c0d186bb41d070e10e">expand_code_make_defverb</a>(content, name):
<a name="l00042"></a>00042     <span class="keywordflow">return</span> <span class="stringliteral">&quot;\\defverbatim[colored]\\%s{\n%s\n}&quot;</span> % (name, content)
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a7d52c80223faaefc49dae45d367082e6">00044</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a7d52c80223faaefc49dae45d367082e6">expand_code_make_lstlisting</a>(content, options):
<a name="l00045"></a>00045     <span class="keywordflow">return</span> <span class="stringliteral">&quot;\\begin{lstlisting}%s%s\\end{lstlisting}&quot;</span> % (options, content)
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a85777fc13697754d6dd7e3fcd9a7f144">00047</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a85777fc13697754d6dd7e3fcd9a7f144">expand_code_search_escape_sequences</a>(code):
<a name="l00048"></a>00048     open = <span class="stringliteral">&#39;1&#39;</span>
<a name="l00049"></a>00049     close = <span class="stringliteral">&#39;2&#39;</span>
<a name="l00050"></a>00050     <span class="keywordflow">while</span> code.find(open) != -1 <span class="keywordflow">or</span> code.find(close) != -1:
<a name="l00051"></a>00051         open = open + chr(random.randint(48,57))
<a name="l00052"></a>00052         close = close + chr(random.randint(48,57))
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordflow">return</span> (open,close)
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="namespaceuicilibris_1_1expand.html#ad024d95772cf38f8738b402dee4db35a">00056</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#ad024d95772cf38f8738b402dee4db35a">expand_code_tokenize_anims</a>(code):
<a name="l00057"></a>00057     <span class="comment">#escape</span>
<a name="l00058"></a>00058     (esc_open, esc_close) = <a class="code" href="namespaceuicilibris_1_1expand.html#a85777fc13697754d6dd7e3fcd9a7f144">expand_code_search_escape_sequences</a>(code)
<a name="l00059"></a>00059     code = code.replace(<span class="stringliteral">&#39;\\[&#39;</span>, esc_open)
<a name="l00060"></a>00060     code = code.replace(<span class="stringliteral">&#39;\\]&#39;</span>, esc_close)
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     p = re.compile(<span class="stringliteral">r&#39;\[\[(?:.|\s)*?\]\]|\[(?:.|\s)*?\]&#39;</span>)
<a name="l00063"></a>00063     non_anim = p.split(code)
<a name="l00064"></a>00064     anim = p.findall(code)
<a name="l00065"></a>00065     
<a name="l00066"></a>00066     <span class="comment">#unescape</span>
<a name="l00067"></a>00067     anim = map(<span class="keyword">lambda</span> s: s.replace(esc_open, <span class="stringliteral">&#39;\\[&#39;</span>).replace(esc_close, <span class="stringliteral">&#39;\\]&#39;</span>), anim)
<a name="l00068"></a>00068     non_anim = map(<span class="keyword">lambda</span> s: s.replace(esc_open, <span class="stringliteral">&#39;[&#39;</span>).replace(esc_close, <span class="stringliteral">&#39;]&#39;</span>), non_anim)
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="keywordflow">return</span> (anim, non_anim)
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a36db1d2ed68f45051157b7f0069b63bb">00072</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a36db1d2ed68f45051157b7f0069b63bb">expand_code_parse_overlayspec</a>(overlayspec):
<a name="l00073"></a>00073     overlays = []
<a name="l00074"></a>00074 
<a name="l00075"></a>00075     groups = overlayspec.split(<span class="stringliteral">&#39;,&#39;</span>)
<a name="l00076"></a>00076     <span class="keywordflow">for</span> group <span class="keywordflow">in</span> groups:
<a name="l00077"></a>00077         group = group.strip()
<a name="l00078"></a>00078         <span class="keywordflow">if</span> group.find(<span class="stringliteral">&#39;-&#39;</span>)!=-1:
<a name="l00079"></a>00079             nums = group.split(<span class="stringliteral">&#39;-&#39;</span>)
<a name="l00080"></a>00080             <span class="keywordflow">if</span> len(nums)&lt;2:
<a name="l00081"></a>00081                 <a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">syntax_error</a>(<span class="stringliteral">&#39;overlay specs must be of the form &lt;(%d-%d)|(%d), ...&gt;&#39;</span>, overlayspec)
<a name="l00082"></a>00082             <span class="keywordflow">else</span>:
<a name="l00083"></a>00083                 <span class="keywordflow">try</span>:
<a name="l00084"></a>00084                     start = int(nums[0])
<a name="l00085"></a>00085                     stop = int(nums[1])
<a name="l00086"></a>00086                 <span class="keywordflow">except</span> ValueError:
<a name="l00087"></a>00087                     <a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">syntax_error</a>(<span class="stringliteral">&#39;not an int, overlay specs must be of the form &lt;(%d-%d)|(%d), ...&gt;&#39;</span>, overlayspec)
<a name="l00088"></a>00088 
<a name="l00089"></a>00089                 overlays.extend(range(start,stop+1))
<a name="l00090"></a>00090         <span class="keywordflow">else</span>:
<a name="l00091"></a>00091             <span class="keywordflow">try</span>:
<a name="l00092"></a>00092                 num = int(group)
<a name="l00093"></a>00093             <span class="keywordflow">except</span> ValueError:
<a name="l00094"></a>00094                 <a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">syntax_error</a>(<span class="stringliteral">&#39;not an int, overlay specs must be of the form &lt;(%d-%d)|(%d), ...&gt;&#39;</span>, overlayspec)
<a name="l00095"></a>00095             overlays.append(num)
<a name="l00096"></a>00096     
<a name="l00097"></a>00097     <span class="comment">#make unique</span>
<a name="l00098"></a>00098     overlays = list(set(overlays))
<a name="l00099"></a>00099     <span class="keywordflow">return</span> overlays
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a3adf073f866155a711055b9c0535bd41">00101</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a3adf073f866155a711055b9c0535bd41">expand_code_parse_simpleanimspec</a>(animspec):
<a name="l00102"></a>00102     <span class="comment">#escape</span>
<a name="l00103"></a>00103     (esc_open, esc_close) = <a class="code" href="namespaceuicilibris_1_1expand.html#a85777fc13697754d6dd7e3fcd9a7f144">expand_code_search_escape_sequences</a>(animspec)
<a name="l00104"></a>00104     animspec = animspec.replace(<span class="stringliteral">&#39;\\[&#39;</span>, esc_open)
<a name="l00105"></a>00105     animspec = animspec.replace(<span class="stringliteral">&#39;\\]&#39;</span>, esc_close)
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     p = re.compile(<span class="stringliteral">r&#39;^\[&lt;([0-9,\-]+)&gt;((?:.|\s)*)\]$&#39;</span>)
<a name="l00108"></a>00108     m = p.match(animspec)
<a name="l00109"></a>00109     <span class="keywordflow">if</span> m != <span class="keywordtype">None</span>:
<a name="l00110"></a>00110         overlays = <a class="code" href="namespaceuicilibris_1_1expand.html#a36db1d2ed68f45051157b7f0069b63bb">expand_code_parse_overlayspec</a>(m.group(1))
<a name="l00111"></a>00111         code = m.group(2)
<a name="l00112"></a>00112     <span class="keywordflow">else</span>:
<a name="l00113"></a>00113         <a class="code" href="namespaceuicilibris_1_1expand.html#a7c2e494ec8fac69541f38ff597769ea1">syntax_error</a>(<span class="stringliteral">&#39;specification does not match [&lt;%d&gt;%s]&#39;</span>, animspec)
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">#unescape code</span>
<a name="l00116"></a>00116     code = code.replace(esc_open, <span class="stringliteral">&#39;[&#39;</span>).replace(esc_close, <span class="stringliteral">&#39;]&#39;</span>)
<a name="l00117"></a>00117     
<a name="l00118"></a>00118     <span class="keywordflow">return</span> [(overlay, code) <span class="keywordflow">for</span> overlay <span class="keywordflow">in</span> overlays]
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a91cba1a887bbe20573806b083121d6eb">00121</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a91cba1a887bbe20573806b083121d6eb">expand_code_parse_animspec</a>(animspec):
<a name="l00122"></a>00122     <span class="keywordflow">if</span> len(animspec)&lt;4 <span class="keywordflow">or</span> <span class="keywordflow">not</span> animspec.startswith(<span class="stringliteral">&#39;[[&#39;</span>):
<a name="l00123"></a>00123         <span class="keywordflow">return</span> (<span class="stringliteral">&#39;simple&#39;</span>, <a class="code" href="namespaceuicilibris_1_1expand.html#a3adf073f866155a711055b9c0535bd41">expand_code_parse_simpleanimspec</a>(animspec))
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     <span class="comment">#escape</span>
<a name="l00126"></a>00126     (esc_open, esc_close) = <a class="code" href="namespaceuicilibris_1_1expand.html#a85777fc13697754d6dd7e3fcd9a7f144">expand_code_search_escape_sequences</a>(animspec)
<a name="l00127"></a>00127     animspec = animspec.replace(<span class="stringliteral">&#39;\\[&#39;</span>, esc_open)
<a name="l00128"></a>00128     animspec = animspec.replace(<span class="stringliteral">&#39;\\]&#39;</span>, esc_close)
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     p = re.compile(<span class="stringliteral">r&#39;\[|\]\[|\]&#39;</span>)
<a name="l00131"></a>00131     simple_specs = map(<span class="keyword">lambda</span> s: <span class="stringliteral">&#39;[%s]&#39;</span>%s, filter(<span class="keyword">lambda</span> s: len(s.strip())&gt;0, p.split(animspec)))
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">#unescape</span>
<a name="l00134"></a>00134     simple_specs = map(<span class="keyword">lambda</span> s: s.replace(esc_open, <span class="stringliteral">&#39;\\[&#39;</span>).replace(esc_close, <span class="stringliteral">&#39;\\]&#39;</span>), simple_specs)
<a name="l00135"></a>00135     parsed_simple_specs = map(expand_code_parse_simpleanimspec, simple_specs)
<a name="l00136"></a>00136     <span class="comment">#print parsed_simple_specs</span>
<a name="l00137"></a>00137     unified_pss = []
<a name="l00138"></a>00138     <span class="keywordflow">for</span> pss <span class="keywordflow">in</span> parsed_simple_specs:
<a name="l00139"></a>00139         unified_pss.extend(pss)
<a name="l00140"></a>00140     <span class="comment">#print unified_pss</span>
<a name="l00141"></a>00141     <span class="keywordflow">return</span> (<span class="stringliteral">&#39;double&#39;</span>, unified_pss)
<a name="l00142"></a>00142     
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="namespaceuicilibris_1_1expand.html#ad3fe792166190040fd892778baa7b447">00144</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#ad3fe792166190040fd892778baa7b447">expand_code_getmaxoverlay</a>(parsed_anims):
<a name="l00145"></a>00145     max_overlay = 0
<a name="l00146"></a>00146     <span class="keywordflow">for</span> anim <span class="keywordflow">in</span> parsed_anims:
<a name="l00147"></a>00147         <span class="keywordflow">for</span> spec <span class="keywordflow">in</span> anim:
<a name="l00148"></a>00148             <span class="keywordflow">if</span> spec[0] &gt; max_overlay:
<a name="l00149"></a>00149                 max_overlay = spec[0]
<a name="l00150"></a>00150     <span class="keywordflow">return</span> max_overlay
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="namespaceuicilibris_1_1expand.html#af9cefca18c66f5901e9063457d69f9b4">00152</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#af9cefca18c66f5901e9063457d69f9b4">expand_code_getminoverlay</a>(parsed_anims):
<a name="l00153"></a>00153     min_overlay = sys.maxint
<a name="l00154"></a>00154     <span class="keywordflow">for</span> anim <span class="keywordflow">in</span> parsed_anims:
<a name="l00155"></a>00155         <span class="keywordflow">for</span> spec <span class="keywordflow">in</span> anim:
<a name="l00156"></a>00156             <span class="keywordflow">if</span> spec[0] &lt; min_overlay:
<a name="l00157"></a>00157                 min_overlay = spec[0]
<a name="l00158"></a>00158     <span class="keywordflow">if</span> min_overlay == sys.maxint:
<a name="l00159"></a>00159         min_overlay = 0
<a name="l00160"></a>00160     <span class="keywordflow">return</span> min_overlay
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a8e259c683afb687da2b775d152ff8e24">00163</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a8e259c683afb687da2b775d152ff8e24">expand_code_genanims</a>(parsed_animspec, minoverlay, maxoverlay, type):
<a name="l00164"></a>00164     <span class="comment">#get maximum length of code</span>
<a name="l00165"></a>00165     maxlen=0
<a name="l00166"></a>00166     <span class="keywordflow">if</span> type==<span class="stringliteral">&#39;double&#39;</span>:
<a name="l00167"></a>00167         <span class="keywordflow">for</span> simple_animspec <span class="keywordflow">in</span> parsed_animspec:
<a name="l00168"></a>00168             <span class="keywordflow">if</span> maxlen &lt; len(simple_animspec[1]):
<a name="l00169"></a>00169                 maxlen = len(simple_animspec[1])
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     out = []
<a name="l00172"></a>00172     fill = <span class="stringliteral">&#39;&#39;</span>.join([<span class="stringliteral">&#39; &#39;</span> <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0, maxlen)])
<a name="l00173"></a>00173     <span class="keywordflow">for</span> x <span class="keywordflow">in</span> xrange(minoverlay,maxoverlay+1):
<a name="l00174"></a>00174         out.append(fill[:])
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordflow">for</span> simple_animspec <span class="keywordflow">in</span> parsed_animspec:
<a name="l00177"></a>00177         out[simple_animspec[0]-minoverlay] = simple_animspec[1]
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="keywordflow">return</span> out
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a7d914ad966c87e16ce149c0c67744b36">00181</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a7d914ad966c87e16ce149c0c67744b36">expand_code_getname</a>(code):
<a name="l00182"></a>00182     asciihextable = string.maketrans(<span class="stringliteral">&#39;0123456789abcdef&#39;</span>,\
<a name="l00183"></a>00183                                      <span class="stringliteral">&#39;abcdefghijklmnop&#39;</span>)
<a name="l00184"></a>00184     d = <a class="code" href="namespaceuicilibris_1_1expand.html#aa7c5fb372f99423998ded9e3bc442bbe">md5hex</a>(code).translate(asciihextable)
<a name="l00185"></a>00185     <span class="keywordflow">return</span> d
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a6875f45969d04e6e263e04e1b50a615c">00187</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a6875f45969d04e6e263e04e1b50a615c">expand_code_makeoverprint</a>(names, minoverlay):
<a name="l00188"></a>00188     out = [<span class="stringliteral">&#39;\\begin{overprint}\n&#39;</span>]
<a name="l00189"></a>00189     <span class="keywordflow">for</span> (index, name) <span class="keywordflow">in</span> enumerate(names):
<a name="l00190"></a>00190         out.append(<span class="stringliteral">&#39;  \\onslide&lt;%d&gt;\\%s\n&#39;</span> % (index+minoverlay, name))
<a name="l00191"></a>00191     out.append(<span class="stringliteral">&#39;\\end{overprint}\n&#39;</span>)
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>.join(out)
<a name="l00194"></a>00194 
<a name="l00195"></a>00195 <span class="comment">##</span>
<a name="l00196"></a>00196 <span class="comment"># generate a collision free entry in the defverbs-map and names-list</span>
<a name="l00197"></a><a class="code" href="namespaceuicilibris_1_1expand.html#a3901a234ee16d466ca5d00b42d206032">00197</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#a3901a234ee16d466ca5d00b42d206032" title="generate a collision free entry in the defverbs-map and names-list">expand_code_get_unique_name</a>(defverbs, code, lstparams):
<a name="l00198"></a>00198     name = <a class="code" href="namespaceuicilibris_1_1expand.html#a7d914ad966c87e16ce149c0c67744b36">expand_code_getname</a>(code)
<a name="l00199"></a>00199     expanded_code = <a class="code" href="namespaceuicilibris_1_1expand.html#acd820eb2d190c4c0d186bb41d070e10e">expand_code_make_defverb</a>(<a class="code" href="namespaceuicilibris_1_1expand.html#a7d52c80223faaefc49dae45d367082e6">expand_code_make_lstlisting</a>(code, lstparams), name)
<a name="l00200"></a>00200     rehash = <span class="stringliteral">&#39;&#39;</span>
<a name="l00201"></a>00201     <span class="keywordflow">while</span> name <span class="keywordflow">in</span> defverbs <span class="keywordflow">and</span> defverbs[name] != expanded_code:
<a name="l00202"></a>00202         rehash += char(random.randint(65,90)) <span class="comment">#append a character from A-Z to rehash value</span>
<a name="l00203"></a>00203         name = expanded_code_getname(code + rehash)
<a name="l00204"></a>00204         expanded_code = <a class="code" href="namespaceuicilibris_1_1expand.html#acd820eb2d190c4c0d186bb41d070e10e">expand_code_make_defverb</a>(<a class="code" href="namespaceuicilibris_1_1expand.html#a7d52c80223faaefc49dae45d367082e6">expand_code_make_lstlisting</a>(code, lstparams), name)
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keywordflow">return</span> (name, expanded_code)
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    
<a name="l00209"></a><a class="code" href="namespaceuicilibris_1_1expand.html#abdb3e9c31f6c9612fb62c0942669b1f3">00209</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#abdb3e9c31f6c9612fb62c0942669b1f3">expand_code_segment</a>(result, codebuffer, state):
<a name="l00210"></a>00210     <span class="comment">#treat first line as params for lstlistings</span>
<a name="l00211"></a>00211     lstparams = codebuffer[0]
<a name="l00212"></a>00212     codebuffer[0] = <span class="stringliteral">&#39;&#39;</span>
<a name="l00213"></a>00213  
<a name="l00214"></a>00214     <span class="comment">#join lines into one string</span>
<a name="l00215"></a>00215     code = <span class="stringliteral">&#39;&#39;</span>.join(codebuffer)
<a name="l00216"></a>00216     <span class="comment">#print code</span>
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="comment">#tokenize code into anim and non_anim parts</span>
<a name="l00219"></a>00219     (anim, non_anim) = <a class="code" href="namespaceuicilibris_1_1expand.html#ad024d95772cf38f8738b402dee4db35a">expand_code_tokenize_anims</a>(code)
<a name="l00220"></a>00220     <span class="comment">#print anim</span>
<a name="l00221"></a>00221     <span class="comment">#print non_anim</span>
<a name="l00222"></a>00222     <span class="keywordflow">if</span> len(anim)&gt;0:
<a name="l00223"></a>00223         <span class="comment">#generate multiple versions of the anim parts</span>
<a name="l00224"></a>00224         parsed_anims = map(expand_code_parse_animspec, anim)
<a name="l00225"></a>00225         <span class="comment">#print parsed_anims</span>
<a name="l00226"></a>00226         max_overlay = <a class="code" href="namespaceuicilibris_1_1expand.html#ad3fe792166190040fd892778baa7b447">expand_code_getmaxoverlay</a>(map(<span class="keyword">lambda</span> x: x[1], parsed_anims))
<a name="l00227"></a>00227         <span class="comment">#if there is unanimated code, use 0 as the starting overlay</span>
<a name="l00228"></a>00228         <span class="keywordflow">if</span> len(non_anim)&gt;0:
<a name="l00229"></a>00229             min_overlay = 1
<a name="l00230"></a>00230         <span class="keywordflow">else</span>:
<a name="l00231"></a>00231             min_overlay = <a class="code" href="namespaceuicilibris_1_1expand.html#af9cefca18c66f5901e9063457d69f9b4">expand_code_getminoverlay</a>(map(<span class="keyword">lambda</span> x: x[1], parsed_anims))
<a name="l00232"></a>00232         <span class="comment">#print min_overlay</span>
<a name="l00233"></a>00233         <span class="comment">#print max_overlay</span>
<a name="l00234"></a>00234         gen_anims = map(<span class="keyword">lambda</span> x: <a class="code" href="namespaceuicilibris_1_1expand.html#a8e259c683afb687da2b775d152ff8e24">expand_code_genanims</a>(x[1], min_overlay, max_overlay, x[0]), parsed_anims)
<a name="l00235"></a>00235         <span class="comment">#print gen_anims</span>
<a name="l00236"></a>00236         anim_map = {}
<a name="l00237"></a>00237         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0,max_overlay-min_overlay+1):
<a name="l00238"></a>00238             anim_map[i+min_overlay] = map(<span class="keyword">lambda</span> x: x[i], gen_anims)
<a name="l00239"></a>00239         <span class="comment">#print anim_map</span>
<a name="l00240"></a>00240     
<a name="l00241"></a>00241         names = []
<a name="l00242"></a>00242         <span class="keywordflow">for</span> overlay <span class="keywordflow">in</span> sorted(anim_map.keys()):
<a name="l00243"></a>00243             <span class="comment">#combine non_anim and anim parts</span>
<a name="l00244"></a>00244             anim_map[overlay].append(<span class="stringliteral">&#39;&#39;</span>)
<a name="l00245"></a>00245             zipped = zip(non_anim, anim_map[overlay])
<a name="l00246"></a>00246             mapped = map(<span class="keyword">lambda</span> x: x[0] + x[1], zipped)
<a name="l00247"></a>00247             code = <span class="stringliteral">&#39;&#39;</span>.join(mapped)
<a name="l00248"></a>00248             
<a name="l00249"></a>00249             <span class="comment">#generate a collision free entry in the defverbs-map and names-list</span>
<a name="l00250"></a>00250             (name, expanded_code) = <a class="code" href="namespaceuicilibris_1_1expand.html#a3901a234ee16d466ca5d00b42d206032" title="generate a collision free entry in the defverbs-map and names-list">expand_code_get_unique_name</a>(state.defverbs, code, lstparams)
<a name="l00251"></a>00251 
<a name="l00252"></a>00252             <span class="comment">#now we have a collision free entry, append it</span>
<a name="l00253"></a>00253             names.append(name)
<a name="l00254"></a>00254             state.defverbs[name] = expanded_code
<a name="l00255"></a>00255         
<a name="l00256"></a>00256         <span class="comment">#append overprint area to result</span>
<a name="l00257"></a>00257         overprint = <a class="code" href="namespaceuicilibris_1_1expand.html#a6875f45969d04e6e263e04e1b50a615c">expand_code_makeoverprint</a>(names, min_overlay)
<a name="l00258"></a>00258         result.append(overprint)
<a name="l00259"></a>00259     <span class="keywordflow">else</span>:
<a name="l00260"></a>00260         <span class="comment">#we have no animations and can just put the defverbatim in</span>
<a name="l00261"></a>00261         <span class="comment">#remove escapings</span>
<a name="l00262"></a>00262         code = code.replace(<span class="stringliteral">&#39;\\[&#39;</span>, <span class="stringliteral">&#39;[&#39;</span>).replace(<span class="stringliteral">&#39;\\]&#39;</span>, <span class="stringliteral">&#39;]&#39;</span>)
<a name="l00263"></a>00263         (name, expanded_code) = <a class="code" href="namespaceuicilibris_1_1expand.html#a3901a234ee16d466ca5d00b42d206032" title="generate a collision free entry in the defverbs-map and names-list">expand_code_get_unique_name</a>(state.defverbs, code, lstparams)  
<a name="l00264"></a>00264         state.defverbs[name] = expanded_code
<a name="l00265"></a>00265         result.append(<span class="stringliteral">&#39;\n\\%s\n&#39;</span> % name)
<a name="l00266"></a>00266 
<a name="l00267"></a>00267     <span class="comment">#print &#39;----&#39;</span>
<a name="l00268"></a>00268     <span class="keywordflow">return</span>
<a name="l00269"></a>00269 
<a name="l00270"></a><a class="code" href="namespaceuicilibris_1_1expand.html#acfb355ad092498b21afc04582c4302ec">00270</a> <span class="keyword">def </span><a class="code" href="namespaceuicilibris_1_1expand.html#acfb355ad092498b21afc04582c4302ec">expand_code_defverbs</a>(result, state):
<a name="l00271"></a>00271         result[state.code_pos] = result[state.code_pos] + <span class="stringliteral">&#39;\n&#39;</span>.join(state.defverbs.values()) + <span class="stringliteral">&#39;\n&#39;</span>
<a name="l00272"></a>00272         state.defverbs={}
<a name="l00273"></a>00273 
<a name="l00274"></a>00274 
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="expand_8py.html">expand.py</a>      </li>

    <li class="footer">Generated on Mon Apr 23 2012 14:56:02 for UiciLibris by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
